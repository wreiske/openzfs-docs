

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Ubuntu 20.04 Root on ZFS for Raspberry Pi &mdash; OpenZFS  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/mandoc.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Project and Community" href="../../Project and Community/index.html" />
    <link rel="prev" title="Ubuntu 20.04 Root on ZFS" href="Ubuntu 20.04 Root on ZFS.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo_main.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Arch Linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FreeBSD.html">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference external" href="https://nixos.wiki/wiki/NixOS_on_ZFS">NixOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openSUSE/index.html">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL and CentOS.html">RHEL and CentOS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Ubuntu</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#root-on-zfs">Root on ZFS</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="Ubuntu 16.04 Root on ZFS.html">Ubuntu 16.04 Root on ZFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="Ubuntu 18.04 Root on ZFS.html">Ubuntu 18.04 Root on ZFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="Ubuntu 20.04 Root on ZFS.html">Ubuntu 20.04 Root on ZFS</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Ubuntu 20.04 Root on ZFS for Raspberry Pi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance and Tuning/index.html">Performance and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basic Concepts/index.html">Basic Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../man/index.html">Man Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenZFS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">Ubuntu</a> &raquo;</li>
        
      <li>Ubuntu 20.04 Root on ZFS for Raspberry Pi</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/openzfs/openzfs-docs/blob/master/docs/Getting Started/Ubuntu/Ubuntu 20.04 Root on ZFS for Raspberry Pi.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ubuntu-20-04-root-on-zfs-for-raspberry-pi">
<h1>Ubuntu 20.04 Root on ZFS for Raspberry Pi<a class="headerlink" href="#ubuntu-20-04-root-on-zfs-for-raspberry-pi" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#caution" id="id2">Caution</a></p></li>
<li><p><a class="reference internal" href="#system-requirements" id="id3">System Requirements</a></p></li>
<li><p><a class="reference internal" href="#support" id="id4">Support</a></p></li>
<li><p><a class="reference internal" href="#contributing" id="id5">Contributing</a></p></li>
<li><p><a class="reference internal" href="#encryption" id="id6">Encryption</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#step-1-disk-formatting" id="id7">Step 1: Disk Formatting</a></p></li>
<li><p><a class="reference internal" href="#step-2-setup-zfs" id="id8">Step 2: Setup ZFS</a></p></li>
<li><p><a class="reference internal" href="#step-3-system-installation" id="id9">Step 3: System Installation</a></p></li>
<li><p><a class="reference internal" href="#step-4-system-configuration" id="id10">Step 4: System Configuration</a></p></li>
<li><p><a class="reference internal" href="#step-5-first-boot" id="id11">Step 5: First Boot</a></p></li>
<li><p><a class="reference internal" href="#step-6-full-software-installation" id="id12">Step 6: Full Software Installation</a></p></li>
<li><p><a class="reference internal" href="#step-7-final-cleanup" id="id13">Step 7: Final Cleanup</a></p></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="caution">
<h3><a class="toc-backref" href="#id2">Caution</a><a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>This HOWTO uses a whole physical SD card.</p></li>
<li><p>Backup your data. Any existing data will be lost.</p></li>
</ul>
</div>
<div class="section" id="system-requirements">
<h3><a class="toc-backref" href="#id3">System Requirements</a><a class="headerlink" href="#system-requirements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A Raspberry Pi 4 B. (If you are looking to install on a regular PC, see
<a class="reference internal" href="Ubuntu 20.04 Root on ZFS.html"><span class="doc">Ubuntu 20.04 Root on ZFS</span></a>.)</p></li>
<li><p><a class="reference external" href="https://cdimage.ubuntu.com/releases/20.04.2/release/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz">Ubuntu Server 20.04.2 (“Focal”) for Raspberry Pi 4</a></p></li>
<li><p>A microSD card. For recommendations, see Jeff Geerling’s <a class="reference external" href="https://www.jeffgeerling.com/blog/2019/raspberry-pi-microsd-card-performance-comparison-2019">performance
comparison</a>.</p></li>
<li><p>An Ubuntu system (with the ability to write to the SD card) other than the
target Raspberry Pi.</p></li>
</ul>
<p>4 GiB of memory is recommended. Do not use deduplication, as it needs <a class="reference external" href="http://wiki.freebsd.org/ZFSTuningGuide#Deduplication">massive
amounts of RAM</a>.
Enabling deduplication is a permanent change that cannot be easily reverted.</p>
<p>A Raspberry Pi 3 B/B+ would probably work (as the Pi 3 is 64-bit, though it
has less RAM), but has not been tested.  Please report your results (good or
bad) using the issue link below.</p>
</div>
<div class="section" id="support">
<h3><a class="toc-backref" href="#id4">Support</a><a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<p>If you need help, reach out to the community using the <a class="reference internal" href="../../Project and Community/Mailing Lists.html#mailing-lists"><span class="std std-ref">Mailing Lists</span></a> or IRC at
<a class="reference external" href="ircs://irc.libera.chat/#zfsonlinux">#zfsonlinux</a> on <a class="reference external" href="https://libera.chat/">Libera Chat</a>. If you have a bug report or feature request
related to this HOWTO, please <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;rlaager,%20I%20have%20the%20following%20issue%20with%20the%20Ubuntu%2020.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi%20HOWTO:">file a new issue and mention &#64;rlaager</a>.</p>
</div>
<div class="section" id="contributing">
<h3><a class="toc-backref" href="#id5">Contributing</a><a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Fork and clone: <a class="reference external" href="https://github.com/openzfs/openzfs-docs">https://github.com/openzfs/openzfs-docs</a></p></li>
<li><p>Install the tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt install python3-pip

pip3 install -r docs/requirements.txt

<span class="c1"># Add ~/.local/bin to your $PATH, e.g. by adding this to ~/.bashrc:</span>
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
</li>
<li><p>Make your changes.</p></li>
<li><p>Test:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
make html
sensible-browser _build/html/index.html
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--signoff</span></code> to a branch, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code>, and create a pull
request. Mention &#64;rlaager.</p></li>
</ol>
</div>
<div class="section" id="encryption">
<h3><a class="toc-backref" href="#id6">Encryption</a><a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p><strong>WARNING:</strong> Encryption has not yet been tested on the Raspberry Pi.</p>
<p>This guide supports three different encryption options: unencrypted, ZFS
native encryption, and LUKS. With any option, all ZFS features are fully
available.</p>
<p>Unencrypted does not encrypt anything, of course. With no encryption
happening, this option naturally has the best performance.</p>
<p>ZFS native encryption encrypts the data and most metadata in the root
pool. It does not encrypt dataset or snapshot names or properties. The
boot pool is not encrypted at all, but it only contains the bootloader,
kernel, and initrd. (Unless you put a password in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, the
initrd is unlikely to contain sensitive data.) The system cannot boot
without the passphrase being entered at the console. Performance is
good. As the encryption happens in ZFS, even if multiple disks (mirror
or raidz topologies) are used, the data only has to be encrypted once.</p>
<p>LUKS encrypts almost everything. The only unencrypted data is the bootloader,
kernel, and initrd. The system cannot boot without the passphrase being
entered at the console. Performance is good, but LUKS sits underneath ZFS, so
if multiple disks (mirror or raidz topologies) are used, the data has to be
encrypted once per disk.</p>
</div>
</div>
<div class="section" id="step-1-disk-formatting">
<h2><a class="toc-backref" href="#id7">Step 1: Disk Formatting</a><a class="headerlink" href="#step-1-disk-formatting" title="Permalink to this headline">¶</a></h2>
<p>The commands in this step are run on the system other than the Raspberry Pi.</p>
<p>This guide has you go to some extra work so that the stock ext4 partition can
be deleted.</p>
<ol class="arabic">
<li><p>Download and unpack the official image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -O https://cdimage.ubuntu.com/releases/20.04.2/release/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz
xz -d ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz

<span class="c1"># or combine them to decompress as you download:</span>
curl https://cdimage.ubuntu.com/releases/20.04.2/release/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz <span class="p">|</span> <span class="se">\</span>
    xz -d &gt; ubuntu-20.04.2-preinstalled-server-arm64+raspi.img
</pre></div>
</div>
</li>
<li><p>Dump the partition table for the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sfdisk -d ubuntu-20.04.2-preinstalled-server-arm64+raspi.img
</pre></div>
</div>
<p>That will output this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>label: dos
label-id: 0x4ec8ea53
device: ubuntu-20.04.2-preinstalled-server-arm64+raspi.img
unit: sectors
&lt;name&gt;.img1 : <span class="nv">start</span><span class="o">=</span>        <span class="m">2048</span>, <span class="nv">size</span><span class="o">=</span>      <span class="m">524288</span>, <span class="nv">type</span><span class="o">=</span>c, bootable
&lt;name&gt;.img2 : <span class="nv">start</span><span class="o">=</span>      <span class="m">526336</span>, <span class="nv">size</span><span class="o">=</span>     <span class="m">5839840</span>, <span class="nv">type</span><span class="o">=</span><span class="m">83</span>
</pre></div>
</div>
<p>The important numbers are 524288 and 5839840.  Store those in variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">BOOT</span><span class="o">=</span><span class="m">524288</span>
<span class="nb">export</span> <span class="nv">ROOT</span><span class="o">=</span><span class="m">5839840</span>
</pre></div>
</div>
</li>
<li><p>Create a partition script:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi partitions.sh
</pre></div>
</div>
<p>with the following contents:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt; EOF</span>
<span class="s">label: dos</span>
<span class="s">unit: sectors</span>

<span class="s">1 : start=  2048,  size=$BOOT, type=c, bootable</span>
<span class="s">2 : start=$((2048+BOOT)),  size=$ROOT, type=83</span>
<span class="s">3 : start=$((2048+BOOT+ROOT)), size=$ROOT, type=83</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Connect the SD card:</p>
<p>Connect the SD card to a machine other than the target Raspberry Pi.  If
any filesystems are automatically mounted (e.g. by GNOME) unmount them.
Determine the device name (which is almost certainly as shown below) and
set it in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0
</pre></div>
</div>
</li>
<li><p>Clear old ZFS labels:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo zpool labelclear -f <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>
</pre></div>
</div>
<p>If a ZFS label still exists from a previous system/attempt, expanding the
pool will result in an unbootable system.</p>
<p><strong>Hint:</strong> If you do not already have the ZFS utilities installed, you can
install them with: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">zfsutils-linux</span></code>  Alternatively, you
can zero the entire SD card with:
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dd</span> <span class="pre">if=/dev/zero</span> <span class="pre">of=${DISK}</span> <span class="pre">bs=1M</span> <span class="pre">status=progress</span></code></p>
</li>
<li><p>Delete existing partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;label: dos&quot;</span> <span class="p">|</span> sudo sfdisk <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>
sudo partprobe
ls <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>*
</pre></div>
</div>
<p>Make sure there are no partitions, just the file for the disk itself.  This
step is not strictly necessary; it exists to catch problems.</p>
</li>
<li><p>Create the partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sh -u partitions.sh <span class="p">|</span> sudo sfdisk <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Loopback mount the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">IMG</span><span class="o">=</span><span class="k">$(</span>sudo losetup -fP --show <span class="se">\</span>
          ubuntu-20.04.2-preinstalled-server-arm64+raspi.img<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Copy the bootloader data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo dd <span class="k">if</span><span class="o">=</span><span class="si">${</span><span class="nv">IMG</span><span class="si">}</span>p1 <span class="nv">of</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p1 <span class="nv">bs</span><span class="o">=</span>1M
</pre></div>
</div>
</li>
<li><p>Clear old label(s) from partition 2:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo wipefs -a <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p2
</pre></div>
</div>
<p>If a filesystem with the <code class="docutils literal notranslate"><span class="pre">writable</span></code> label from the Ubuntu image is still
present in partition 2, the system will not boot initially.</p>
</li>
<li><p>Copy the root filesystem data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE: the destination is p3, not p2.</span>
sudo dd <span class="k">if</span><span class="o">=</span><span class="si">${</span><span class="nv">IMG</span><span class="si">}</span>p2 <span class="nv">of</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p3 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">status</span><span class="o">=</span>progress <span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
</li>
<li><p>Unmount the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo losetup -d <span class="nv">$IMG</span>
</pre></div>
</div>
</li>
<li><p>Boot the Raspberry Pi.</p>
<p>Move the SD card into the Raspberry Pi. Boot it and login (e.g. via SSH)
with <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code> as the username and password.  If you are using SSH, note
that it takes a little bit for cloud-init to enable password logins on the
first boot.  Set a new password when prompted and login again using that
password.  If you have your local SSH configured to use <code class="docutils literal notranslate"><span class="pre">ControlPersist</span></code>,
you will have to kill the existing SSH process before logging in the second
time.</p>
</li>
</ol>
</div>
<div class="section" id="step-2-setup-zfs">
<h2><a class="toc-backref" href="#id8">Step 2: Setup ZFS</a><a class="headerlink" href="#step-2-setup-zfs" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Become root:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo -i
</pre></div>
</div>
</li>
<li><p>Set a variable with the disk name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0
</pre></div>
</div>
<p>On the Pi, this is always <code class="docutils literal notranslate"><span class="pre">mmcblk0</span></code>.</p>
</li>
<li><p>Install ZFS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt update

apt install pv zfs-initramfs
</pre></div>
</div>
<p><strong>Note:</strong> Since this is the first boot, you may get <code class="docutils literal notranslate"><span class="pre">Waiting</span> <span class="pre">for</span> <span class="pre">cache</span>
<span class="pre">lock</span></code> because <code class="docutils literal notranslate"><span class="pre">unattended-upgrades</span></code> is running in the background.
Wait for it to finish.</p>
</li>
<li><p>Create the root pool:</p>
<p>Choose one of the following options:</p>
<ul>
<li><p>Unencrypted:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
    -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    -O <span class="nv">acltype</span><span class="o">=</span>posixacl -O <span class="nv">canmount</span><span class="o">=</span>off -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
    -O <span class="nv">dnodesize</span><span class="o">=</span>auto -O <span class="nv">normalization</span><span class="o">=</span>formD -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
    -O <span class="nv">xattr</span><span class="o">=</span>sa -O <span class="nv">mountpoint</span><span class="o">=</span>/ -R /mnt <span class="se">\</span>
    rpool <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p2
</pre></div>
</div>
</li>
</ul>
<p><strong>WARNING:</strong> Encryption has not yet been tested on the Raspberry Pi.</p>
<ul>
<li><p>ZFS native encryption:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
    -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    -O <span class="nv">encryption</span><span class="o">=</span>aes-256-gcm <span class="se">\</span>
    -O <span class="nv">keylocation</span><span class="o">=</span>prompt -O <span class="nv">keyformat</span><span class="o">=</span>passphrase <span class="se">\</span>
    -O <span class="nv">acltype</span><span class="o">=</span>posixacl -O <span class="nv">canmount</span><span class="o">=</span>off -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
    -O <span class="nv">dnodesize</span><span class="o">=</span>auto -O <span class="nv">normalization</span><span class="o">=</span>formD -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
    -O <span class="nv">xattr</span><span class="o">=</span>sa -O <span class="nv">mountpoint</span><span class="o">=</span>/ -R /mnt <span class="se">\</span>
    rpool <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p2
</pre></div>
</div>
</li>
<li><p>LUKS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cryptsetup luksFormat -c aes-xts-plain64 -s <span class="m">512</span> -h sha256 <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p2
cryptsetup luksOpen <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4 luks1
zpool create <span class="se">\</span>
    -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    -O <span class="nv">acltype</span><span class="o">=</span>posixacl -O <span class="nv">canmount</span><span class="o">=</span>off -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
    -O <span class="nv">dnodesize</span><span class="o">=</span>auto -O <span class="nv">normalization</span><span class="o">=</span>formD -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
    -O <span class="nv">xattr</span><span class="o">=</span>sa -O <span class="nv">mountpoint</span><span class="o">=</span>/ -R /mnt <span class="se">\</span>
    rpool /dev/mapper/luks1
</pre></div>
</div>
</li>
</ul>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4 KiB (or larger) physical sectors, even though they
present 512 B logical sectors. Also, a future replacement drive may
have 4 KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4 KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">acltype=posixacl</span></code> enables POSIX ACLs globally. If you
do not want this, remove that option, but later add
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">acltype=posixacl</span></code> (note: lowercase “o”) to the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code>
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, as <a class="reference external" href="https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported">journald requires ACLs</a>
Also, <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/nfs-utils/+bug/1779736">disabling ACLs apparently breaks umask handling with NFSv4</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only filenames</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recordsize</span></code> is unset (leaving it at the default of 128 KiB). If you
want to tune it (e.g. <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">recordsize=1M</span></code>), see <a class="reference external" href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">these</a> <a class="reference external" href="http://blog.programster.org/zfs-record-size">various</a> <a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSFileRecordsizeGrowth">blog</a>
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSRecordsizeAndCompression">posts</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">relatime=on</span></code> is a middle ground between classic POSIX
<code class="docutils literal notranslate"><span class="pre">atime</span></code> behavior (with its significant performance impact) and
<code class="docutils literal notranslate"><span class="pre">atime=off</span></code> (which provides the best performance by completely
disabling atime updates). Since Linux 2.6.30, <code class="docutils literal notranslate"><span class="pre">relatime</span></code> has been
the default for other filesystems. See <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime">RedHat’s documentation</a>
for further information.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355">vastly improves the performance of extended
attributes</a>.
Inside ZFS, extended attributes are used to implement POSIX ACLs.
Extended attributes can also be used by user-space applications.
<a class="reference external" href="https://en.wikipedia.org/wiki/Extended_file_attributes#Linux">They are used by some desktop GUI applications.</a>
<a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs">They can be used by Samba to store Windows ACLs and DOS attributes;
they are required for a Samba Active Directory domain controller.</a>
Note that <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> is <a class="reference external" href="https://openzfs.org/wiki/Platform_code_differences">Linux-specific</a>. If you move your
<code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> pool to another OpenZFS implementation besides ZFS-on-Linux,
extended attributes will not be readable (though your data will be). If
portability of extended attributes is important to you, omit the
<code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">xattr=sa</span></code> above. Even if you do not want <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> for the whole
pool, it is probably fine to use it for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</p></li>
<li><p>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part4</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</p></li>
<li><p>ZFS native encryption defaults to <code class="docutils literal notranslate"><span class="pre">aes-256-ccm</span></code>, but <a class="reference external" href="https://github.com/openzfs/zfs/commit/31b160f0a6c673c8f926233af2ed6d5354808393">the default has
changed upstream</a>
to <code class="docutils literal notranslate"><span class="pre">aes-256-gcm</span></code>. <a class="reference external" href="https://crypto.stackexchange.com/questions/6842/how-to-choose-between-aes-ccm-and-aes-gcm-for-storage-volume-encryption">AES-GCM seems to be generally preferred over AES-CCM</a>,
<a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749#issuecomment-569132997">is faster now</a>,
and <a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749">will be even faster in the future</a>.</p></li>
<li><p>For LUKS, the key size chosen is 512 bits. However, XTS mode requires two
keys, so the LUKS key is split in half. Thus, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">512</span></code> means AES-256.</p></li>
<li><p>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup FAQ</a>
for guidance.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="step-3-system-installation">
<h2><a class="toc-backref" href="#id9">Step 3: System Installation</a><a class="headerlink" href="#step-3-system-installation" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Create a filesystem dataset to act as a container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none rpool/ROOT
</pre></div>
</div>
</li>
<li><p>Create a filesystem dataset for the root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">100</span> <span class="m">2</span>&gt;/dev/null <span class="p">|</span>
    tr -dc <span class="s1">&#39;a-z0-9&#39;</span> <span class="p">|</span> cut -c-6<span class="k">)</span>

zfs create -o <span class="nv">canmount</span><span class="o">=</span>noauto -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
    -o com.ubuntu.zsys:bootfs<span class="o">=</span>yes <span class="se">\</span>
    -o com.ubuntu.zsys:last-used<span class="o">=</span><span class="k">$(</span>date +%s<span class="k">)</span> rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
zfs mount rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>With ZFS, it is not normally necessary to use a mount command (either
<code class="docutils literal notranslate"><span class="pre">mount</span></code> or <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">mount</span></code>). This situation is an exception because of
<code class="docutils literal notranslate"><span class="pre">canmount=noauto</span></code>.</p>
</li>
<li><p>Create datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o com.ubuntu.zsys:bootfs<span class="o">=</span>no <span class="se">\</span>
    rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/srv
zfs create -o com.ubuntu.zsys:bootfs<span class="o">=</span>no -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
    rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/usr
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/usr/local
zfs create -o com.ubuntu.zsys:bootfs<span class="o">=</span>no -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
    rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/games
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/AccountsService
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/apt
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/dpkg
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/NetworkManager
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/log
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/mail
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/snap
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/spool
zfs create rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/www

zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
    rpool/USERDATA
zfs create -o com.ubuntu.zsys:bootfs-datasets<span class="o">=</span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span> <span class="se">\</span>
    -o <span class="nv">canmount</span><span class="o">=</span>on -o <span class="nv">mountpoint</span><span class="o">=</span>/root <span class="se">\</span>
    rpool/USERDATA/root_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>If you want a separate dataset for <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o com.ubuntu.zsys:bootfs<span class="o">=</span>no <span class="se">\</span>
    rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/tmp
chmod <span class="m">1777</span> /mnt/tmp
</pre></div>
</div>
<p>The primary goal of this dataset layout is to separate the OS from user
data. This allows the root filesystem to be rolled back without rolling
back user data.</p>
<p>If you do nothing extra, <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> will be stored as part of the root
filesystem. Alternatively, you can create a separate dataset for <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>,
as shown above. This keeps the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> data out of snapshots of your root
filesystem. It also allows you to set a quota on <code class="docutils literal notranslate"><span class="pre">rpool/tmp</span></code>, if you want
to limit the maximum space used. Otherwise, you can use a tmpfs (RAM
filesystem) later.</p>
</li>
<li><p>Optional: Ignore synchronous requests:</p>
<p>SD cards are relatively slow.  If you want to increase performance
(especially when installing packages) at the cost of some safety, you can
disable flushing of synchronous requests (e.g. <code class="docutils literal notranslate"><span class="pre">fsync()</span></code>, <code class="docutils literal notranslate"><span class="pre">O_[D]SYNC</span></code>):</p>
<p>Choose one of the following options:</p>
<ul>
<li><p>For the root filesystem, but not user data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs <span class="nb">set</span> <span class="nv">sync</span><span class="o">=</span>disabled rpool/ROOT
</pre></div>
</div>
</li>
<li><p>For everything:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs <span class="nb">set</span> <span class="nv">sync</span><span class="o">=</span>disabled rpool
</pre></div>
</div>
</li>
</ul>
<p>ZFS is transactional, so it will still be crash consistent.  However, you
should leave <code class="docutils literal notranslate"><span class="pre">sync</span></code> at its default of <code class="docutils literal notranslate"><span class="pre">standard</span></code> if this system needs
to guarantee persistence (e.g. if it is a database or NFS server).</p>
</li>
<li><p>Copy the system into the ZFS filesystems:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="nb">cd</span> /<span class="p">;</span> tar -cf - --one-file-system --warning<span class="o">=</span>no-file-ignored .<span class="o">)</span> <span class="p">|</span> <span class="se">\</span>
    pv -p -bs <span class="k">$(</span>du -sxm --apparent-size / <span class="p">|</span> cut -f1<span class="k">)</span>m <span class="p">|</span> <span class="se">\</span>
    <span class="o">(</span><span class="nb">cd</span> /mnt <span class="p">;</span> tar -x<span class="o">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="step-4-system-configuration">
<h2><a class="toc-backref" href="#id10">Step 4: System Configuration</a><a class="headerlink" href="#step-4-system-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Configure the hostname:</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> with the desired hostname:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> HOSTNAME &gt; /mnt/etc/hostname
vi /mnt/etc/hosts
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Add a line:
127.0.1.1       HOSTNAME
or if the system has a real name in DNS:
127.0.1.1       FQDN HOSTNAME
</pre></div>
</div>
<p><strong>Hint:</strong> Use <code class="docutils literal notranslate"><span class="pre">nano</span></code> if you find <code class="docutils literal notranslate"><span class="pre">vi</span></code> confusing.</p>
</li>
<li><p>Stop <code class="docutils literal notranslate"><span class="pre">zed</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl stop zed
</pre></div>
</div>
</li>
<li><p>Bind the virtual filesystems from the running environment to the new
ZFS environment and <code class="docutils literal notranslate"><span class="pre">chroot</span></code> into it:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mount --rbind /boot/firmware /mnt/boot/firmware
mount --rbind /dev  /mnt/dev
mount --rbind /proc /mnt/proc
mount --rbind /run  /mnt/run
mount --rbind /sys  /mnt/sys
chroot /mnt /usr/bin/env <span class="nv">DISK</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">UUID</span><span class="o">=</span><span class="nv">$UUID</span> bash --login
</pre></div>
</div>
</li>
<li><p>Configure a basic system environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt update
</pre></div>
</div>
<p>Even if you prefer a non-English system language, always ensure that
<code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span></code> is available:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dpkg-reconfigure locales
dpkg-reconfigure tzdata
</pre></div>
</div>
</li>
<li><p>For LUKS installs only, setup <code class="docutils literal notranslate"><span class="pre">/etc/crypttab</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup is already installed, but this marks it as manually</span>
<span class="c1"># installed so it is not automatically removed.</span>
apt install --yes cryptsetup

<span class="nb">echo</span> luks1 <span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4<span class="k">)</span> none <span class="se">\</span>
    luks,discard,initramfs &gt; /etc/crypttab
</pre></div>
</div>
<p>The use of <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> is a work-around for <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not support
ZFS</a>.</p>
</li>
<li><p>Optional: Mount a tmpfs to <code class="docutils literal notranslate"><span class="pre">/tmp</span></code></p>
<p>If you chose to create a <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> dataset above, skip this step, as they
are mutually exclusive choices. Otherwise, you can put <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> on a
tmpfs (RAM filesystem) by enabling the <code class="docutils literal notranslate"><span class="pre">tmp.mount</span></code> unit.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp /usr/share/systemd/tmp.mount /etc/systemd/system/
systemctl <span class="nb">enable</span> tmp.mount
</pre></div>
</div>
</li>
<li><p>Patch a dependency loop:</p>
<p>For ZFS native encryption or LUKS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl https://launchpadlibrarian.net/478315221/2150-fix-systemd-dependency-loops.patch <span class="p">|</span> <span class="se">\</span>
    sed <span class="s2">&quot;s|/etc|/lib|;s|\.in</span>$<span class="s2">||&quot;</span> <span class="p">|</span> <span class="o">(</span><span class="nb">cd</span> / <span class="p">;</span> sudo patch -p1<span class="o">)</span>
</pre></div>
</div>
<p>This patch is from <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/zfs-linux/+bug/1875577">Bug #1875577 Encrypted swap won’t load on 20.04 with
zfs root</a>.</p>
</li>
<li><p>Fix filesystem mount ordering:</p>
<p>We need to activate <code class="docutils literal notranslate"><span class="pre">zfs-mount-generator</span></code>. This makes systemd aware of
the separate mountpoints, which is important for things like <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>
and <code class="docutils literal notranslate"><span class="pre">/var/tmp</span></code>. In turn, <code class="docutils literal notranslate"><span class="pre">rsyslog.service</span></code> depends on <code class="docutils literal notranslate"><span class="pre">var-log.mount</span></code>
by way of <code class="docutils literal notranslate"><span class="pre">local-fs.target</span></code> and services using the <code class="docutils literal notranslate"><span class="pre">PrivateTmp</span></code> feature
of systemd automatically use <code class="docutils literal notranslate"><span class="pre">After=var-tmp.mount</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir /etc/zfs/zfs-list.cache
touch /etc/zfs/zfs-list.cache/rpool
ln -s /usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d
zed -F <span class="p">&amp;</span>
</pre></div>
</div>
<p>Force a cache update:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs <span class="nb">set</span> <span class="nv">canmount</span><span class="o">=</span>noauto rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>Verify that <code class="docutils literal notranslate"><span class="pre">zed</span></code> updated the cache by making sure this is not empty,
which will take a few seconds:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat /etc/zfs/zfs-list.cache/rpool
</pre></div>
</div>
<p>Stop <code class="docutils literal notranslate"><span class="pre">zed</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">fg</span>
Press Ctrl-C.
</pre></div>
</div>
<p>Fix the paths to eliminate <code class="docutils literal notranslate"><span class="pre">/mnt</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -Ei <span class="s2">&quot;s|/mnt/?|/|&quot;</span> /etc/zfs/zfs-list.cache/*
</pre></div>
</div>
</li>
<li><p>Remove old filesystem from <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi /etc/fstab
<span class="c1"># Remove the old root filesystem line:</span>
<span class="c1">#   LABEL=writable / ext4 ...</span>
</pre></div>
</div>
</li>
<li><p>Configure kernel command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp /boot/firmware/cmdline.txt /boot/firmware/cmdline.txt.bak
sed -i <span class="s2">&quot;s|root=LABEL=writable rootfstype=ext4|root=ZFS=rpool/ROOT/ubuntu_</span><span class="nv">$UUID</span><span class="s2">|&quot;</span> <span class="se">\</span>
    /boot/firmware/cmdline.txt
sed -i <span class="s2">&quot;s| fixrtc||&quot;</span> /boot/firmware/cmdline.txt
sed -i <span class="s2">&quot;s|</span>$<span class="s2">| init_on_alloc=0|&quot;</span> /boot/firmware/cmdline.txt
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fixrtc</span></code> script is not compatible with ZFS and will cause the boot
to hang for 180 seconds.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">init_on_alloc=0</span></code> is to address <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1862822">performance regressions</a>.</p>
</li>
<li><p>Optional (but highly recommended): Make debugging booting easier:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s2">&quot;s|</span>$<span class="s2">| nosplash|&quot;</span> /boot/firmware/cmdline.txt
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
reboot
</pre></div>
</div>
<p>Wait for the newly installed system to boot normally. Login as <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code>
and become root with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-i</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="step-5-first-boot">
<h2><a class="toc-backref" href="#id11">Step 5: First Boot</a><a class="headerlink" href="#step-5-first-boot" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Delete the ext4 partition and expand the ZFS partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sfdisk /dev/mmcblk0 --delete <span class="m">3</span>
<span class="nb">echo</span> <span class="s2">&quot;, +&quot;</span> <span class="p">|</span> sfdisk --no-reread -N <span class="m">2</span> /dev/mmcblk0
</pre></div>
</div>
<p><strong>Note:</strong> This does not automatically expand the pool.  That will be happen
on reboot.</p>
</li>
<li><p>Create a user account:</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">username</span></code> with your desired username:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">100</span> <span class="m">2</span>&gt;/dev/null <span class="p">|</span>
    tr -dc <span class="s1">&#39;a-z0-9&#39;</span> <span class="p">|</span> cut -c-6<span class="k">)</span>
<span class="nv">ROOT_DS</span><span class="o">=</span><span class="k">$(</span>zfs list -o name <span class="p">|</span> awk <span class="s1">&#39;/ROOT\/ubuntu_/{print $1;exit}&#39;</span><span class="k">)</span>
zfs create -o com.ubuntu.zsys:bootfs-datasets<span class="o">=</span><span class="nv">$ROOT_DS</span> <span class="se">\</span>
    -o <span class="nv">canmount</span><span class="o">=</span>on -o <span class="nv">mountpoint</span><span class="o">=</span>/home/username <span class="se">\</span>
    rpool/USERDATA/username_<span class="nv">$UUID</span>
adduser username

cp -a /etc/skel/. /home/username
chown -R username:username /home/username
usermod -a -G adm,cdrom,dip,lxd,plugdev,sudo username
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>reboot
</pre></div>
</div>
<p>Wait for the system to boot normally. Login with your username and become
root with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-i</span></code>.</p>
</li>
<li><p>Expand the ZFS pool:</p>
<p>Verify the pool expanded:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs list rpool
</pre></div>
</div>
<p>If it did not automatically expand, try to expand it manually:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool online -e rpool mmcblk0p2
</pre></div>
</div>
</li>
<li><p>Delete the <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code> user:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>deluser --remove-home ubuntu
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="step-6-full-software-installation">
<h2><a class="toc-backref" href="#id12">Step 6: Full Software Installation</a><a class="headerlink" href="#step-6-full-software-installation" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Optional: Remove cloud-init:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi /etc/netplan/01-netcfg.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span> <span class="nt">network</span><span class="p">:</span>
   <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
   <span class="nt">ethernets</span><span class="p">:</span>
     <span class="nt">eth0</span><span class="p">:</span>
       <span class="nt">dhcp4</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="l l-Scalar l-Scalar-Plain">rm /etc/netplan/50-cloud-init.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">apt purge --autoremove ^cloud-init</span>
</pre></div>
</div>
</li>
<li><p>Optional: Remove other storage packages:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt purge --autoremove bcache-tools btrfs-progs cloud-guest-utils lvm2 <span class="se">\</span>
    mdadm multipath-tools open-iscsi overlayroot xfsprogs
</pre></div>
</div>
</li>
<li><p>Upgrade the minimal system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt dist-upgrade --yes
</pre></div>
</div>
</li>
<li><p>Optional: Install a full GUI environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt install --yes ubuntu-desktop
</pre></div>
</div>
<p><strong>Hint</strong>: If you are installing a full GUI environment, you will likely
want to remove cloud-init as discussed above but manage your network with
NetworkManager:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rm /etc/netplan/*.yaml
vi /etc/netplan/01-network-manager-all.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">network</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">renderer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NetworkManager</span>
</pre></div>
</div>
</li>
<li><p>Optional (but recommended): Disable log compression:</p>
<p>As <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> is already compressed by ZFS, logrotate’s compression is
going to burn CPU and disk I/O for (in most cases) very little gain. Also,
if you are making snapshots of <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, logrotate’s compression will
actually waste space, as the uncompressed data will live on in the
snapshot. You can edit the files in <code class="docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code> by hand to comment
out <code class="docutils literal notranslate"><span class="pre">compress</span></code>, or use this loop (copy-and-paste highly recommended):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> file in /etc/logrotate.d/* <span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> grep -Eq <span class="s2">&quot;(^|[^#y])compress&quot;</span> <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">then</span>
        sed -i -r <span class="s2">&quot;s/(^|[^#y])(compress)/\1#\2/&quot;</span> <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>reboot
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="step-7-final-cleanup">
<h2><a class="toc-backref" href="#id13">Step 7: Final Cleanup</a><a class="headerlink" href="#step-7-final-cleanup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Wait for the system to boot normally. Login using the account you
created. Ensure the system (including networking) works normally.</p></li>
<li><p>Optional: For LUKS installs only, backup the LUKS header:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo cryptsetup luksHeaderBackup /dev/disk/by-id/scsi-SATA_disk1-part4 <span class="se">\</span>
    --header-backup-file luks1-header.dat
</pre></div>
</div>
<p>Store that backup somewhere safe (e.g. cloud storage). It is protected by
your LUKS passphrase, but you may wish to use additional encryption.</p>
<p><strong>Hint:</strong> If you created a mirror or raidz topology, repeat this for each
LUKS volume (<code class="docutils literal notranslate"><span class="pre">luks2</span></code>, etc.).</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../../Project and Community/index.html" class="btn btn-neutral float-right" title="Project and Community" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Ubuntu 20.04 Root on ZFS.html" class="btn btn-neutral float-left" title="Ubuntu 20.04 Root on ZFS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, OpenZFS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>